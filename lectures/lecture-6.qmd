---
title: "Lecture 6: the tidyverse"
---

Today, we're going to talk about the tidyverse, a collection of R packages that are designed to work together to make data manipulation and visualization easier. All the packages we've seen before (`readr`, `ggplot2`, `tibble`) are actually part of the tidyverse.  It also includes other packages, like `dplyr` for data manipulation, and `purrr` for functional programming, as well as many others.

Our goal: make a super nice plot to definitively answer the question: did soccer get less exciting over time?

```{r}
#| label: setup

library(tidyverse) # the mighty package!
df <- read_csv("./data/lecture-1-england.csv")
```

## The pipe operator: chaining commands together

```{r}
#| label: the pipe

# example: turn lowercase letters into uppercase letters, then bind them together

# approach 1: intermediate variables
upperletters <- toupper(letters)
paste(upperletters, collapse = "")
# this is bad because you end up storing a lot of intermediate variables
# those end up cluttering your environment
# which makes it harder to keep track of what's going on
# e.g.: you create a new object, will it overwrite an existing one?

# approach 2: nesting functions
paste(toupper(letters), collapse = "")
# you fix the clutter problem, but it can get hard to
# read when you have a lot of nested functions

# approach 3: the pipe operator
# the pipe operator takes the output of one function and
# feeds it into the first argument of the next function
letters |> toupper() # this
toupper(letters) # is the same as this

# so we can chain together multiple functions
# without having to create intermediate variables or nest functions
letters |>
  toupper() |>
  paste(collapse = "")
```

## Data manipulation with dplyr

### The basics: select(), rename(), mutate(), filter(), group_by(), summarize()

```{r}
#| label: data manipulation

# let's get the mean number of goals per game for each decade
# we store this into a new data frame called pl, my shorthand for "plot"
pl <- df |>
  # select(): selects only the columns you need
  select(Season, totgoal) |>
  # rename(): rename columns to make them easier to work with
  rename(season = Season, goals = totgoal) |>
  # mutate(): create new variables based on existing ones
  mutate(
    # you can do any kind of transformation you want in mutate()
    decade = season / 10,
    # they are applied sequentially, so you can use the variables you just created
    decade = floor(decade) * 10
  ) |>
  # filter(): filter rows based on some condition
  # you apply multiple filters sequentially, and they are combined with "and"
  filter(decade > 1880, decade < 2020) |>
  # magic trick: you can use group_by() and summarize() to do group-wise operations
  group_by(decade) |>
  summarize(goals = mean(goals))
```

```{r}
#| label: data visualization 1

ggplot(pl, aes(x = decade, y = goals)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Decade",
    y = "Average number of goals per game",
    title = "Did soccer get less exciting over time?"
  )
```

### More on group_by()

```{r}
# you can group by multiple variables, and then summarize or mutate within those groups
# e.g., we want the mean number of home goals per team per season
df |>
  select(season = Season, team = home, goals = hgoal) |>
  group_by(season, team) |>
  summarize(goals = mean(goals))

# notice that the output is a data frame with one row per team per season
# also notice that it still has a grouping structure
# The output says: "Groups:   season [123]"
# this means that the data frame is still grouped by season,
# so if we do another group-wise operation, it will be done within each season
# this may or may not be what we want, depending on what we want to do next
# to remove the grouping structure, we can use ungroup()

df |>
  select(season = Season, team = home, goals = hgoal) |>
  group_by(season, team) |>
  summarize(goals = mean(goals)) |>
  ungroup()

# which decade was most exciting?
# group_by() and summarize(): group-wise operations that compress data into a single row per group
# arrange(): sorting data

df_decade <- df |>
  select(season = Season, goals = totgoal) |>
  mutate(
    decade = floor(season / 10) * 10
  ) |>
  filter(decade > 1880, decade < 2020)

df_decade |>
  group_by(decade) |>
  summarize(goals = mean(goals)) |>
  arrange(-goals)

# which team had the most home goals relative to others?
# group_by() and mutate(): group-wise operations that keep the same number of rows

df |>
  select(season = Season, team = home, goals = hgoal) |>
  mutate(
    decade = floor(season / 10) * 10
  ) |>
  filter(decade > 1880, decade < 2020) |>
  group_by(decade, team) |>
  summarize(goals = mean(goals)) |>
  group_by(decade) |>
  mutate(goals = goals - mean(goals)) |>
  ungroup() |>
  arrange(-goals)
```

## More complicated manipulation: loops (bad) vs. map functions (good)

```{r}
#| label: loops vs. map functions

ci <- function(v) {
  x_bar <- mean(v)
  s <- sd(v)
  n <- length(v)
  std_error <- s / sqrt(n)
  lower_bound_z <- x_bar + std_error * qnorm(p = 0.025, mean = 0, sd = 1)
  upper_bound_z <- x_bar + std_error * qnorm(p = 0.975, mean = 0, sd = 1)
  c(
    "lower.bound" = lower_bound_z,
    "upper.bound" = upper_bound_z
  )
}

df_decade
pl <- tibble(
  decade = numeric(),
  goals = numeric(),
  lower.bound = numeric(),
  upper.bound = numeric()
)

decades <- unique(df_decade$decade)

for (this_decade in decades) {
  this_data <- df_decade |>
    filter(decade == this_decade)
  this_ci <- ci(this_data$goals)
  this_pl <- tibble(
    decade = this_decade,
    goals = mean(this_data$goals),
    lower.bound = this_ci["lower.bound"],
    upper.bound = this_ci["upper.bound"]
  )
  pl <- bind_rows(pl, this_pl)
}

# let's add confidence intervals to our plot
```


```{r}
#| label: data visualization 2

# let's make the ultimate plot to answer the question: did soccer get less exciting over time?
```